---
title: "Salamanders by the Sea: Site Fidelity and Interpool Movement of Spotted Salamanders Breeding in Rocky Cliff Pools"
author: "Georgia Lattig"
date: "03/01/24"
output: github_document
---

```{r load-packages, include = FALSE}
library(tidyverse)
library(broom)
library(readr)
library(ggplot2)
library(dplyr)
library(lubridate)
library(igraph)
install.packages("ggnetwork")
library(ggnetwork)
install.packages("intergraph")
library(intergraph)
```

```{r load-data, include = TRUE}
pools <- read_csv("/cloud/project/data/tidy_data/pools.csv")
sals <- read_csv("/cloud/project/data/tidy_data/sals.csv")
```
## Data Processing

```{r assigning-first_year-22-23}
(p22 <- sals %>% 
    filter(pit_year == "2022"))

sals <- sals %>% 
  mutate(first_year = case_when(
    pit %in% `2022pits` ~ "2022",
    .default = first_year
  ))

# Separate out the PIT tags that only appeared in 2023 by using an anti_join with individuals22 

pits23 <- sals %>%
  mutate(pit = as.character(pit)) %>%
  anti_join(individuals22, by = "pit")

(p23 <- sals %>% 
  filter(pit %in% pits23$pit))

sals <- sals %>% 
  mutate(first_year = case_when(
    pit %in% p23 ~ "2023",
    .default = first_year
  ))

sals <- sals %>% 
  mutate(color = case_when(
    first_year == "2017" ~ "yellow",
    first_year == "2018" ~ "pink",
    first_year == "2019" ~ "orange",
    first_year == "2020_2021" ~ "red",
    first_year == "2022" ~ "blue",
    first_year == "2023" ~ "green"
  ))
```

To date there have been 249 unique PIT tags deployed within the Otter Point population of salamanders. Below I ran some code to see which PIT tags, if any, had multiple years/colors associated with them. Out of 249 PIT tags, 46 are associated with more than one year (first year observed/marked)/color. 

```{r check-pits}
sals %>% 
  group_by(first_year) %>% 
  count()

sals %>% 
  group_by(pit) %>% 
  count(first_year)

#This code revealed that there is an erroneous pit tag 1299 (I think this is actually the IMG file number). Keep this in mind as I'll have to omit the observation? from my visualizations/analysis.

sals %>% 
  count(pit)
```

Though this is a major pain, I am going to look through the data for each of these 46 PIT tags to determine which color/year should be associated with them. Then I will create a massive case_when function to recode the PIT tags as necessary. I will recode based on information about year of first PIT tag (these are concrete data) or based on the most frequent color tag recorded across seasons. In cases with equal numbers of observations of different color tags, I looked for additional information in the notes column or else trusted the first observation because of increased sampling effort in 2022.

```{r recode-pit-year}
sals <- sals %>% 
  mutate(first_year = case_when(
    pit == "3216" ~ "2020_2021", #once recorded as pink in 2023 but all other times, across 2 seasons, red
    pit == "3218" ~ "2022", #recorded as new in 2023 but was first tagged with PIT in 2022; was NOT double-tagged
    pit == "3229" ~ "2020_2021", #once recorded as pink in 2023 but all other times, across 2 seasons, red
    pit == "3234" ~ "2022", #first tagged with PIT in 2022
    pit == "3237" ~ "2017", #yellow tag likely missed in first/only encounter in 2022, all other observations are yellow
    pit == "3244" ~ "2018", #recorded red in 2022 but accompanying notes read "kind of pink VIE" + recorded pink in 2023
    pit == "3248" ~ "2020_2021", #once recorded as pink in 2023 but all other times, across 2 seasons, red
    pit == "3262" ~ "2018", #once recorded as orange in 2023 but all other times, across nights, pink
    pit == "3273" ~ "2020_2021", #no color recorded in 2022 but multiple nights in 2023 recorded red
    pit == "3275" ~ "2022", #no color recorded when first PIT tagged 2022 nor all other times except one "yellow" in 2023 ***
    pit == "3284" ~ "2022", #first tagged with PIT in 2022
    pit == "3289" ~ "2018", #recorded pink 4 nights in 2022 and red 3 nights in 2023...
    pit == "3304" ~ "2019", #recorded 2x orange in 2022 including accompanying notes about the orange tag, 2023 "might not be pink, hard to tell"
    pit == "3316" ~ "2020_2021", #1x red in 2022, 1x orange in 2023; trusted 2022 observation due to larger field crew and "effort"
    pit == "3321" ~ "2022", #no color recorded when first PIT tagged 2022 nor other times except one "yellow" in 2023 ***
    pit == "3322" ~ "2020_2021", #once recorded as orange in 2023 but all other times, across nights, red
    pit == "3328" ~ "2020_2021", #once no color recorded in 2023 but all other times, across nights, red
    pit == "3339" ~ "2017", #once recorded red in 2023 but all other times, across nights, yellow
    pit == "3343" ~ "2022", #first tagged with PIT in 2022
    pit == "3345" ~ "2022", #first tagged with PIT in 2022, all observations no color except one orange record in 2023
    pit == "3358" ~ "2022", #first tagged with PIT in 2022
    pit == "3359" ~ "2020_2021", #once recorded orange in 2023 but all other times, across nights, red
    pit == "3360" ~ "2018", #no color recorded but notes say pink
    pit == "3361" ~ "2019", #no color recorded when first PIT tagged in 2022 nor other 2022 observations but twice recorded as orange in 2023
    pit == "3363" ~ "2020_2021", #once no color recorded in 2023 but all other times, across seasons, red
    pit == "3370" ~ "2019", #recorded orange 4x in 2022, once pink and twice red in 2023
    pit == "3374" ~ "2017", #yellow tag likely missed in first/only encounter in 2022, all other observations are yellow
    pit == "3375" ~ "2017", #recorded yellow across 3 nights in 2023, no colors recorded in all prior observations ***
    pit == "3377" ~ "2022", #UV light forgotten so no color tag but first tagged with PIT 2022
    pit == "3380" ~ "2022", #first tagged with PIT in 2022
    pit == "3382" ~ "2022", #first tagged with PIT in 2022
    pit == "3383" ~ "2022", #first tagged with PIT in 2022
    pit == "3393" ~ "2022", #first tagged with PIT in 2022
    pit == "3396" ~ "2020_2021", #once recorded pink in 2023 but all other times, across seasons, red
    pit == "3399" ~ "2022", #no color recorded when first PIT tagged in 2022 nor all other 2022 observations except 2x recorded as red in 2023 with accompanying notes "may not be red"
    pit == "3401" ~ "2020_2021", #no color recorded when first PIT tagged in 2022 and only once recorded "red" but additional notes from another night say "has color tag but couldn't read it" ***
    pit == "3402" ~ "2019", #once recorded pink in 2023 but all other times, across nights, orange
    pit == "3403" ~ "2020_2021", #once recorded pink in 2023 but all other times, across seasons, red
    pit == "4741" ~ "2018", #always recorded pink
    pit == "4752" ~ "2019", #most often recorded orange
    pit == "4766" ~ "2023", #first tagged with PIT in 2023
    pit == "4797" ~ "2020_2021", #possible that the red color tag was missed when first PIT tagged 2023
    pit == "4832" ~ "2020_2021", #possible that the red color tag was missed when first PIT tagged 2023, all other times red
    pit == "4838" ~ "2023", #first tagged with PIT in 2023
    pit == "4842" ~ "2023", #first tagged with PIT in 2023
    pit == "4854" ~ "2023", #first tagged with PIT in 2023
    pit == "4880" ~ "2023", #first tagged with PIT in 2023
    pit == "4883" ~ "2023", #first tagged with PIT in 2023
    pit == "4888" ~ "2023", #first tagged with PIT in 2023
    pit == "4898" ~ "2020_2021", #possible that the red color tag was missed when first PIT tagged 2023, all other times red
    .default = first_year
  ))

sals <- sals %>% 
  mutate(color = case_when(
    first_year == "2017" ~ "yellow",
    first_year == "2018" ~ "pink",
    first_year == "2019" ~ "orange",
    first_year == "2020_2021" ~ "red",
    first_year == "2022" ~ "blue",
    first_year == "2023" ~ "green"
  ))
```


```{r recode-pit-year-variable}
sals <- sals %>% 
  mutate(pit = as.character(pit)) %>% 
  mutate(pit_year = as.character(pit_year)) %>% 
  mutate(pit_year = case_when(
    pit %in% p23$pit ~ "2023",
    pit %in% p22$pit ~ "2022",
    .default = pit_year
  ))
```


```{r check-pit-year-again, include = FALSE}
sals %>% 
  group_by(pit) %>% 
  count(first_year)

#Below I removed the erroneous observation of PIT #1299 from the dataset (a single observation on 03/31/22)
sals <- sals %>% 
  filter(pit != "1299" |
        is.na(pit)) %>% 
  mutate(pit = as.character(pit)) %>% 
  mutate(pool = as.character(pool))
```

```{r create-observation-year-variable}
sals <- sals %>% 
  mutate(date = as.Date(date)) %>% 
  mutate(year = as.numeric(format(date,'%Y'))) %>% 
  mutate(year = as.character(year)) %>% 
  mutate(year = case_when(
    year == "23" ~ "2023",
    .default = year))
```

```{r pit-counts-by-year}
sals %>% 
  group_by(year) %>% 
  count()

sals %>% 
  group_by(pit) %>% 
  count()

#The code below creates proportions of visits at n/sum(n) breeding pools for each individual 
sals %>% 
  group_by(pit) %>% 
  count(pool) %>% 
  mutate(pool_prop = n/sum(n))
```
```{r visualize-most-popular-breeding-pools}
sals %>% 
  drop_na(pit) %>% #Only look at tagged individuals
  group_by(pit) %>% #Will grouping by PIT remove duplicate observations?
  group_by(year) %>% 
  count(pool) %>% 
  mutate(pool = factor(pool, levels = c("0","1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16"))) %>%
  ggplot(aes(pool, n), fill = first_year) + #Okay what am I actually plotting here?
  geom_col() + 
  facet_wrap(~ year) +
  labs(title = "Breeding Pools Used by PIT Tagged Salamanders",
       subtitle = "Across Two Seasons",
       x = "Pool",
       y = "PIT Tagged Individuals Observed")

sals %>% 
  group_by(year) %>% 
  group_by(pit) %>% 
  count(pool)

pools <- pools %>% 
  mutate(date = as.Date(date)) %>% 
  mutate(year = as.numeric(format(date,'%Y'))) 

pools <- pools %>% 
  mutate(year = as.character(year)) %>% 
  mutate(year = case_when(
    year == "20" ~ "2020",
    year == "21" ~ "2021",
    .default = year)) 

pools %>% 
  filter(year %in% c("2016","2017","2018","2019","2020","2021")) %>% 
  mutate(pool = factor(pool, levels = c("0","1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16"))) %>%
  drop_na(pool) %>% 
  ggplot(aes(pool, total), fill = first_year) + #Okay what am I actually plotting here?
  geom_col() + 
  facet_wrap(~ year) +
  labs(title = "Breeding Pools Used by Salamanders",
       subtitle = "Across Seven Seasons",
       x = "Pool",
       y = "Total Salamander Observations")
```

```{r observations-per-year}
sals %>% 
  group_by(year) %>% 
  count()
#There were more salamander observations than just 291 but the data in 2023 did not record untagged/uncaptured salamanders as their own rows
```
## Modeling

### Site Fidelity

How can I make a model that looks at site fidelity? First I would need to modify the data some more, creating a categorical variable `fidelity` for individuals that have returned to the same pool across years "yes" or have not returned to the same pool across years "no". Then I could try to predict the response of the return categorical variable based on salinity? (high/low category or just numerical)...

```{r set-up-data-for-model-fidelity}
sals_sight_twice <- sals %>% 
  group_by(pit, year) %>% 
  arrange(date) %>% 
  slice(1) %>% #Get the first row (pool) for each year that the salamander was observed
  ungroup() %>%
  group_by(pit) %>%
  summarise(sightings = n()) %>%
  filter(sightings > 1) %>% #Filter for salamanders observed across two years
  pull(pit) 

sals_fidelity <- sals %>% 
  filter(pit %in% sals_sight_twice) %>%
  group_by(pit, year) %>% 
  slice(1) %>%
  ungroup() %>%
  group_by(pit) %>%
  summarise(pools = toString(pool)) %>%
  separate_wider_delim(cols = pools, delim = ", ", names = c("pool1", "pool2")) %>%
  mutate(fidelity = case_when(pool1 == pool2 ~ "yes",
                               TRUE ~ "no"))

environ22 <- sals %>% 
  filter(pit %in% sals_sight_twice) %>%
  group_by(pit, year) %>% 
  slice(1) %>% 
  filter(year == "2022") %>% 
  rename(pool1_salinity = salinity,
         pool1_temp = pool_temp,
         pool1 = pool,
         year1 = year,
         date1 = date) %>% 
  select(date1, year1, pool1, pit, pool1_salinity, pool1_temp)

environ23 <- sals %>% 
  filter(pit %in% sals_sight_twice) %>%
  group_by(pit, year) %>% 
  slice(1) %>% 
  filter(year == "2023") %>% 
  rename(pool2_salinity = salinity,
         pool2_temp = pool_temp,
         pool2 = pool,
         year2 = year,
         date2 = date) %>% 
  select(date2, year2, pool2, pit, pool2_salinity, pool2_temp)

fidelity <- left_join(sals_fidelity, environ22, by = c("pool1", "pit"))
fidelity <- left_join(fidelity, environ23, by = c("pool2", "pit"))

fidelity <- fidelity %>% 
  mutate(salinity_change = pool2_salinity - pool1_salinity) %>% #Should it be pool2 - pool1 or the other way around?
  mutate(temp_change = pool2_temp - pool1_temp)
```

Then with the model, walk through all the necessary steps of data splitting into training/testing...

```{r lm-returns-by-salinity}
fidelity_main_fit <- linear_reg() %>%
  set_engine("lm") %>%
  fit(fidelity ~ salinity + pool_temp + pool, data = sals)
tidy(fidelity_main_fit)
```

